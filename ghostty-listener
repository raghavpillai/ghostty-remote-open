#!/usr/bin/env python3
"""Listener that opens new Ghostty windows for SSH remote requests.

Runs on the local Mac. Remote machines send requests via SSH reverse
port forwarding to open a new Ghostty window SSH'd to a specific
host and directory.

Protocol: single line "host:directory\n" over TCP.
"""

import socket
import subprocess
import os
import signal
import sys

PORT = 7681


def handle_request(data):
    data = data.strip()
    if ":" not in data:
        return
    host, directory = data.split(":", 1)
    if not host or not directory:
        return
    # Open a new Ghostty window SSH'd to the host at the directory.
    helper = os.path.expanduser("~/.local/bin/ghostty-ssh-open")
    subprocess.Popen([
        "/Applications/Ghostty.app/Contents/MacOS/ghostty",
        f"--command={helper} {host} {directory}",
    ])


def main():
    signal.signal(signal.SIGTERM, lambda *_: sys.exit(0))

    sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
    sock.setsockopt(socket.SOL_SOCKET, socket.SO_REUSEADDR, 1)
    sock.bind(("127.0.0.1", PORT))
    sock.listen(5)

    while True:
        conn, _ = sock.accept()
        try:
            data = conn.recv(4096).decode("utf-8", errors="replace")
            handle_request(data)
        except Exception:
            pass
        finally:
            conn.close()


if __name__ == "__main__":
    main()
